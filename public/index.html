<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <style type="text/css">
    canvas:-webkit-full-screen {
      width: 100%;
      /*height: 100%;*/
    }
    canvas{
      width: 0%;
      -webkit-transition: all 0.5s;
      transition: all 0.5s;
      outline:none;
    }
    td{
      text-align: center;
      cursor: pointer;
      padding: 8px;
      font-size: 18px;
    }
    td:hover{
      background-color: black;
      color: white;
      transition: all 0.5s ease;
    }
    </style>
</head>
<body style="text-align:center;">
    <div id="conatiner">
      <canvas id="canvas"></canvas>
    </div>
    <div style="clear:both">
    <div id="controls" style="display:none;text-align:center;margin:0 auto;">
      <table style="text-align:center;margin:0 auto;">
        <tr>
          <td onclick="sendSpecial('recentapps')">apps</td>
          <td onclick="sendSpecial('menu')">menu</td>
          <td onclick="sendSpecial('home')">home</td>
          <td onclick="sendSpecial('search')">search</td>
          <td onclick="sendSpecial('back')">back</td>
        </tr>
        <tr>
          <td onclick="sendSpecial('landscape')">L</td>
          <td onclick="sendSpecial('portrait')">P</td>
          <td onclick="sendSpecial('power')">power</td>
          <!-- <td onclick="start()">start</td> -->
          <!-- <td onclick="stop()">stop</td> -->
        </tr>
      </table>
    </div>
    <!-- <input type="button" value="hs" text="fs" onclick="goFS()"/> -->
    <script src="/js/WebGLCanvas.js"></script>
    <script src="/js/Decoder.js"></script>
    <script src="/js/Player.js"></script>
    <script src="/js/video_player.js"></script>
    <script src="/js/mpeg.js"></script>
    <script src="/js/format_reader.js"></script>
    <script src="/js/audio_player.js"></script>
    <script src="/js/interaction.js"></script>
    <script src="/js/mousewheel.js"></script>
    <script>
      var host = window.location.hostname;
      // var host = '192.168.1.2';
      // var host = '192.168.1.4';
      // var host = '10.100.101.74';
    	var ws_vidpath = 'ws://' + host + ':8081';
      var ws_audpath = 'ws://' + host + ':8082';

      var VideoPlayer = new H264Player();
      var canvas = VideoPlayer.canvas;
      var old_canvas = document.getElementById('canvas');
      old_canvas.parentNode.replaceChild(canvas, old_canvas);
      var vid = new ws_client(ws_vidpath,
        function(data){
          VideoPlayer.decodeRaw(new Uint8Array(data));
        },
        function(){
          window.ws = vid.ws;
        }
      );

      var buff = [], src = '';
      var buffer_counter = 0, a_counter = 0;
      var audio_s_length = 10, buffer_length = 7;
      var audios = [];
      for(var i = 0; i < audio_s_length; i++){
        var a = new Audio();
        a.autoplay = true;
        a.defaultPlaybackRate = 1;
        a.normalize();
        audios.push(a);
      }
      var audio = audios[0];

      // var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      // var source = audioCtx.createBufferSource();
      // var _buffer = (new Uint8Array()).buffer;
      // var _appendBuffer = function(buffer) {
      //   var tmp = new Uint8Array(_buffer.byteLength + buffer.byteLength);
      //   tmp.set(new Uint8Array(_buffer), 0);
      //   tmp.set(new Uint8Array(buffer), _buffer.byteLength);
      //   _buffer = tmp.buffer;
      // };
      var aud = new ws_client(ws_audpath,
        function(data){
          // FormatReader.PushData(data);
          buff.push(new Uint8Array(data));
          // _appendBuffer(data);
          if(buffer_counter == buffer_length){
            buffer_counter = 0;
            audio.muted = true;
            audio = audios[a_counter];
            URL.revokeObjectURL(src);
            src = URL.createObjectURL(new Blob(buff, {type:'audio/mpeg'}))
            audio.src = src;
            audio.muted = false;
            buff = [];
            a_counter++;
            if(a_counter >= audio_s_length)
              a_counter = 0;

            // audioCtx.decodeAudioData(_buffer, function(buffer) {
            //   source = audioCtx.createBufferSource();
            //   source.buffer = buffer;
            //   source.connect(audioCtx.destination);
            //   source.start(0);
            // },
            // function(e){"Error with decoding audio data", e});
            // _buffer = (new Uint8Array()).buffer;
          }
          buffer_counter++;
        },
        function(){
          // var AudioPlayer = new PCMAudioPlayer();
          // window.FormatReader = new AudioFormatReader('audio/mpeg',
          //   function(){
          //     console.log("Reader error: Decoding failed.");
          //   },
          //   function(){
          //     while (FormatReader.SamplesAvailable())
          //       AudioPlayer.PushBuffer(FormatReader.PopSamples());
          //   }
          // );
        }
      );

      function ws_client(ws_path, onmessage, onopen){
        var self = this;
        function connect(){
          var ws = new WebSocket(ws_path);
          self.ws = ws;
          ws.binaryType = "arraybuffer";
          ws.onopen = onopen;
          ws.onmessage = function(msg){
            if(typeof(msg.data) != 'string')
              onmessage(msg.data);
            else if(msg.data == 'kick'){
              ws.onclose = null;
              ws.close();
            }
            else {
              var data = JSON.parse(msg.data);
              console.log(data);
              if(data.width && data.height){
                canvas.style.width = data.width + 'px';
                canvas.style.height = data.height + 'px';
                canvas.width = data.width;
                canvas.height = data.height;
                if(data.platform == 'android'){
                  canvas.android = true;
                  document.getElementById('controls').style.display = 'block';
                  setOrientation(data.orientation);
                  canvas.style.cursor = "pointer";
                }
                else{

                }
              }
              else if(data.status == 'orientation')
                setOrientation(data.value);
            }
          }
          ws.onclose = function(){
            setTimeout(function(){
              connect();
            }, 1000);
          }
        }
        connect();
      }

      initInteractions();

      window.angle = 0;
      function setOrientation(value){
        switch(value){
          case 0: angle = 0;break;
          case 1: angle = -90;break;
          case 2: angle = -180;break;
          case 3: angle = 90;break;
        }
        canvas.style.transform = "rotate(" + angle.toString() + "deg)";
      }

      function goFS(){
        if (canvas.requestFullscreen) {
          canvas.requestFullscreen();
        } else if (canvas.msRequestFullscreen) {
          canvas.msRequestFullscreen();
        } else if (canvas.mozRequestFullScreen) {
          canvas.mozRequestFullScreen();
        } else if (canvas.webkitRequestFullscreen) {
          canvas.webkitRequestFullscreen();
        }
      }
    </script>
</body>
</html>
