<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="/css/style.css">
</head>
<body style="text-align:center;width:1005;height:100%">
    <div id="cockpit" style="display:none;" title="double click to open/close controls">
      <div id="bar">clipboard</div>
      <!-- <button style="background-color:#a9db80">start</button> -->
      <!-- <button style="background-color:#f2825b">stop</button> -->
      <!-- <button style="background-color:#fceabb;">reconnect</button> -->
      <div id="holder" style="display:none">
        <textarea type="text" id="clipbox" style="width:90%;margin-top:15px;resize:none;" row="2"></textarea>
        <button style="background-color:#a7c7dc" onclick="setClip();">set</button>
        <button style="background-color:#a7c7dc;margin-bottom:10px;" onclick="getClip();">get</button>
      </div>
    </div>
    <div id="conatiner">
      <canvas id="canvas"></canvas>
    </div>
    <div style="clear:both">
    <div id="controls" style="display:none;text-align:center;margin:0 auto;">
      <table style="text-align:center;margin:0 auto;">
        <tr>
          <td onclick="sendSpecial('recentapps')">apps</td>
          <td onclick="sendSpecial('menu')">menu</td>
          <td onclick="sendSpecial('home')">home</td>
          <td onclick="sendSpecial('search')">search</td>
          <td onclick="sendSpecial('back')">back</td>
        </tr>
        <tr>
          <td onclick="sendSpecial('landscape')">L</td>
          <td onclick="sendSpecial('portrait')">P</td>
          <td onclick="sendSpecial('power')">power</td>
        </tr>
      </table>
    </div>
    <!-- <input type="button" value="hs" text="fs" onclick="goFS()"/> -->
    <script src="/js/jquery-2.1.4.min.js"></script>
    <script src="/js/mpeg.js"></script>
    <script src="/js/format_reader.js"></script>
    <script src="/js/audio_player.js"></script>
    <script src="/js/mousewheel.js"></script>

    <script src="/js/WebGLCanvas.js"></script>
    <script src="/js/Decoder.js"></script>
    <script src="/js/Player.js"></script>
    <script src="/js/video_player.js"></script>
    <script src="/js/audio_players.js"></script>
    <script src="/js/interaction.js"></script>
    <script src="/js/interact-1.2.4.min.js"></script>
    <script>
      var host = window.location.hostname;
      // var host = '192.168.1.2';
      // var host = '192.168.1.4';
      // var host = '10.100.101.74';

    	var ws_vidpath = 'ws://' + host + ':8081';
      var ws_audpath = 'ws://' + host + ':8082';

      var videoPlayer = new H264Player();

      var canvas = videoPlayer.canvas;
      var old_canvas = document.getElementById('canvas');
      old_canvas.parentNode.replaceChild(canvas, old_canvas);
      var vid = new ws_client(ws_vidpath,function(data){
        videoPlayer.play(data);
      },function(){
        window.ws = vid.ws;
      });

      // var audioPlayer = new AudioPlayerContext('audio/aac');
      // var audioPlayer = new AudioPlayerURL('audio/aac');
      // var audioPlayer = new AudioPlayerJS('audio/mpeg');
      var audioPlayer = new AudioPlayerMSE('audio/aac');
      var aud = new ws_client(ws_audpath, function(data){
        audioPlayer.play(data);
      });

      function ws_client(ws_path, onmessage, onopen){
        var self = this;
        function connect(){
          var ws = new WebSocket(ws_path);
          self.ws = ws;
          ws.binaryType = "arraybuffer";
          ws.onopen = onopen;
          ws.onmessage = function(msg){
            if(typeof(msg.data) != 'string')
              onmessage(msg.data);
            else if(msg.data == 'kick'){
              ws.onclose = null;
              ws.close();
            }
            else {
              var data = JSON.parse(msg.data);
              if(data.platform) initPlatform(data);
              else if(data.status == 'orientation') setOrientation(data.value);
              else if(data.status == 'clip') onClip(data.value);
              else if(data.status == 'cursor') setCursor(data.value);
            }
          }
          ws.onclose = function(){
            setTimeout(function(){
              connect();
            }, 1000);
          }
        }
        connect();
      }

      function initPlatform(data){
        console.log(data);
        if(!window.platform){
          window.cockpit = document.getElementById('cockpit');
          document.getElementById('bar').ondblclick = function(){
            $('#holder').slideToggle();
          }
          cockpit.style.display = 'block';

          interact('#cockpit')
          .draggable({
            inertia: true,
            restrict: {
              restriction: "parent",
              endOnly: true,
              elementRect: { top: 0, left: 0, bottom: 1, right: 1 }
            },
            onmove: function(event) {
              var target = event.target,
              x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
              y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
              target.style.webkitTransform =
              target.style.transform = 'translate(' + x + 'px, ' + y + 'px)';
              target.setAttribute('data-x', x);
              target.setAttribute('data-y', y);
            }
          });
        }
        window.platform = data.platform;
        canvas.style.width = data.width + 'px';
        canvas.style.height = data.height + 'px';
        canvas.width = data.width;
        canvas.height = data.height;
        canvas.focus();
        if(data.platform == 'android'){
          canvas.android = true;
          document.getElementById('controls').style.display = 'block';
          setOrientation(data.orientation);
          canvas.style.cursor = "pointer";
        }
      }

      initInteractions();
    </script>
</body>
</html>
