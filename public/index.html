<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <style type="text/css">
    canvas:-webkit-full-screen {
      /*width: 100%;*/
      /*height: 100%;*/
    }
    </style>
</head>
<body style="text-align:center;margin:0;">
    <canvas id="canvas"></canvas>
    <input type="button" value="hs" text="fs" onclick="goFS()"/>
    <script src="/js/WebGLCanvas.js"></script>
    <script src="/js/Decoder.js"></script>
    <script src="/js/Player.js"></script>
    <script src="/js/video_player.js"></script>
    <script src="/js/mpeg.js"></script>
    <script src="/js/format_reader.js"></script>
    <script src="/js/audio_player.js"></script>
    <script src="/js/interaction.js"></script>
    <script src="/js/mousewheel.js"></script>
    <script>
      var host = window.location.hostname;
      // var host = '192.168.1.2';
    	var ws_vidpath = 'ws://' + host + ':8081';
      var ws_audpath = 'ws://' + host + ':8082';

      var VideoPlayer = new H264Player();
      var canvas = VideoPlayer.canvas;
      var old_canvas = document.getElementById('canvas');
      old_canvas.parentNode.replaceChild(canvas, old_canvas);
      var vid = new ws_client(ws_vidpath,
        function(data){
          VideoPlayer.decodeRaw(new Uint8Array(data));
        },
        function(){
          window.ws = vid.ws;
        }
      );

      var aud = new ws_client(ws_audpath,
        function(data){
          FormatReader.PushData(data);
        },
        function(){
          var AudioPlayer = new PCMAudioPlayer();
          window.FormatReader = new AudioFormatReader('audio/mpeg', 
            function(){
              console.log("Reader error: Decoding failed.");
            },
            function(data){
              while (FormatReader.SamplesAvailable())
                AudioPlayer.PushBuffer(FormatReader.PopSamples());
            }
          );
        }
      );

      function ws_client(ws_path, onmessage, onopen){
        var self = this;
        function connect(){
          var ws = new WebSocket(ws_path);
          self.ws = ws;
          ws.binaryType = "arraybuffer";
          ws.onopen = onopen;
          ws.onmessage = function(msg){
            if(typeof(msg.data) != 'string')
              onmessage(msg.data);
            else if(msg.data == 'kick'){
              ws.onclose = null;
              ws.close();
            }
            else {
              var data = JSON.parse(msg.data);
              if(data.width && data.height){
                canvas.width = data.width;
                canvas.height = data.height;
              }
            }
          }
          ws.onclose = function(){
            setTimeout(function(){
              connect();
            }, 1000);
          }
        }
        connect();
      }

      initInteractions();
      function goFS(){
        if (canvas.requestFullscreen) {
          canvas.requestFullscreen();
        } else if (canvas.msRequestFullscreen) {
          canvas.msRequestFullscreen();
        } else if (canvas.mozRequestFullScreen) {
          canvas.mozRequestFullScreen();
        } else if (canvas.webkitRequestFullscreen) {
          canvas.webkitRequestFullscreen();
        }
      }
    </script>
</body>
</html>
